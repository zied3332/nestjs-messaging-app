<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Messaging App (Socket)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f6f8; }
    .app { height: 100vh; display: grid; grid-template-columns: 280px 1fr; }

    /* Sidebar */
    .sidebar {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .brand { font-size: 18px; font-weight: 800; margin: 0; }
    .sub { font-size: 12px; color: #6b7280; margin-top: -8px; }

    .search {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
    }

    .users {
      flex: 1;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 6px;
    }

    .userItem {
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      background: #fafafa;
      transition: 0.15s;
    }

    .userItem:hover { transform: translateY(-1px); }
    .userItem.active { border-color: #2563eb; background: #eff6ff; }

    .userTop { display: flex; justify-content: space-between; gap: 8px; align-items: center; }

    .userName { font-weight: 800; font-size: 14px; color: #111; }
    .userId { font-size: 11px; color: #6b7280; word-break: break-all; }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      display: inline-block;
      text-transform: uppercase;
    }
    .pill.sent { background: #dbeafe; color: #1e40af; }
    .pill.seen { background: #dcfce7; color: #166534; }

    .sidebarActions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
    }
    button.primary { background: #2563eb; color: white; }
    button.gray { background: #e5e7eb; }
    button.dangerBtn { background: #fee2e2; color: #991b1b; }

    /* Main */
    .main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
    }

    .headerCard {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title { font-size: 18px; font-weight: 900; margin: 0; }
    .status { margin-left: auto; font-size: 13px; color: #555; }
    .danger { color: #b91c1c; font-size: 12px; }

    .composer {
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .composer input {
      flex: 1;
      min-width: 240px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
    }

    .messagesCard {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
      flex: 1;
      overflow: auto;
    }

    .messagesTop {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .hint { font-size: 12px; color: #6b7280; }
    .list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }

    .msg {
      padding: 12px;
      border-radius: 12px;
      background: #f3f4f6;
      border: 1px solid #eee;
    }

    .msg.mine {
      background: #eff6ff;
      border-color: #bfdbfe;
    }

    .meta {
      font-size: 12px;
      color: #555;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .content { font-size: 14px; color: #111; white-space: pre-wrap; }
    .msgActions { margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }

    .empty {
      padding: 14px;
      border: 1px dashed #ddd;
      border-radius: 12px;
      color: #6b7280;
      background: #fafafa;
      font-size: 13px;
      margin-top: 10px;
    }

    /* ---------- Auth Modal ---------- */
    .modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }

    .modal {
      width: 100%;
      max-width: 460px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      padding: 16px;
    }

    .modal h2 { margin: 0; font-size: 18px; }
    .modal p { margin: 6px 0 0; font-size: 12px; color: #6b7280; }

    .grid2 {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .grid2 input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
    }

    .modalFooter {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
    }

    .modalError { color: #b91c1c; font-size: 12px; }

    .chip {
      font-size: 12px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
      padding: 6px 10px;
      border-radius: 999px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .chip b { font-size: 12px; }

    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { height: 42vh; }
      .main { height: 58vh; }
    }
  </style>
</head>

<body>
  <!-- AUTH MODAL -->
  <div class="modalOverlay" id="authOverlay">
    <div class="modal">
      <h2>üîê Auth</h2>
      <p>Login or Register using username + password (JWT backend).</p>

      <div class="grid2">
        <input id="authUsername" type="text" placeholder="username (ex: zied)" autocomplete="username" />
        <input id="authPassword" type="password" placeholder="password" autocomplete="current-password" />
      </div>

      <div class="modalFooter">
        <span class="modalError" id="authError"></span>
        <button class="gray" id="btnRegister">Register</button>
        <button class="primary" id="btnLogin">Login</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- LEFT: Users -->
    <aside class="sidebar">
      <p class="brand">üí¨ Messaging App</p>
      <p class="sub" id="sidebarSub">Login to start</p>

      <div class="sidebarActions">
        <span class="chip" id="meChip" style="display:none;">
          Logged as <b id="meName">-</b>
        </span>
        <button class="dangerBtn" id="btnLogout" style="display:none;">Logout</button>
      </div>

      <input id="userSearch" class="search" type="text" placeholder="Search user..." disabled />

      <div class="sidebarActions">
        <button class="gray" id="btnReloadUsers" disabled>‚Üª Reload</button>
      </div>

      <div id="usersList" class="users"></div>

      <div class="hint">
        Backend: <b>POST /auth/register</b>, <b>POST /auth/login</b>
      </div>
    </aside>

    <!-- RIGHT: Messages -->
    <main class="main">
      <div class="headerCard">
        <p class="title" id="selectedTitle">üë§ Select a user</p>
        <span class="status" id="connStatus">Connecting...</span>
        <span id="error" class="danger"></span>
      </div>

      <div class="composer">
        <input id="msgInput" type="text" placeholder="Type a message..." disabled />
        <button class="primary" id="btnSend" disabled>Send</button>
        <button class="gray" id="btnLoadOld" disabled>Load messages</button>
      </div>

      <div class="messagesCard">
        <div class="messagesTop">
          <b>üì® Messages</b>
          <span class="hint" id="hintText">Login, then pick a user to load messages.</span>
        </div>

        <div id="list" class="list"></div>
        <div id="emptyState" class="empty" style="display:none;">
          No messages for this user yet.
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const BASE_URL = "http://localhost:3001";

    // ‚úÖ store both token + user
    const LS_KEY = "messaging_auth"; // { token, user }
    let me = null;      // { _id, username }
    let token = null;   // JWT string

    // UI refs
    const usersListEl = document.getElementById("usersList");
    const userSearchEl = document.getElementById("userSearch");
    const btnReloadUsers = document.getElementById("btnReloadUsers");
    const sidebarSub = document.getElementById("sidebarSub");
    const meChip = document.getElementById("meChip");
    const meName = document.getElementById("meName");
    const btnLogout = document.getElementById("btnLogout");

    const selectedTitle = document.getElementById("selectedTitle");
    const connStatus = document.getElementById("connStatus");
    const errorEl = document.getElementById("error");

    const msgInput = document.getElementById("msgInput");
    const btnSend = document.getElementById("btnSend");
    const btnLoadOld = document.getElementById("btnLoadOld");

    const list = document.getElementById("list");
    const emptyState = document.getElementById("emptyState");
    const hintText = document.getElementById("hintText");

    // auth modal refs
    const authOverlay = document.getElementById("authOverlay");
    const authUsername = document.getElementById("authUsername");
    const authPassword = document.getElementById("authPassword");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");
    const authError = document.getElementById("authError");

    // state
    let allUsers = [];
    let selectedUser = null;

    function setError(msg) { errorEl.textContent = msg ? " ‚Äî " + msg : ""; }
    function setAuthError(msg) { authError.textContent = msg || ""; }

    function formatDate(iso) {
      try { return new Date(iso).toLocaleString(); }
      catch { return ""; }
    }

    function clearMessagesUI() {
      list.innerHTML = "";
      emptyState.style.display = "none";
    }

    function showEmptyIfNeeded() {
      emptyState.style.display = list.children.length === 0 ? "block" : "none";
    }

    function setUiLocked(locked) {
      userSearchEl.disabled = locked;
      btnReloadUsers.disabled = locked;

      msgInput.disabled = locked || !selectedUser;
      btnSend.disabled = locked || !selectedUser;
      btnLoadOld.disabled = locked || !selectedUser;
    }

    function openAuthModal() {
      authOverlay.style.display = "flex";
      setUiLocked(true);
      setAuthError("");
      setTimeout(() => authUsername.focus(), 0);
    }

    function closeAuthModal() {
      authOverlay.style.display = "none";
    }

    function saveAuth(data) {
      token = data.access_token;
      me = data.user;
      localStorage.setItem(LS_KEY, JSON.stringify({ token, user: me }));

      meName.textContent = me.username;
      meChip.style.display = "inline-flex";
      btnLogout.style.display = "inline-flex";
      sidebarSub.textContent = "Logged in. Select a user to see messages.";
      hintText.textContent = "Pick a user to load messages.";

      setUiLocked(false);
    }

    function clearAuth() {
      token = null;
      me = null;
      localStorage.removeItem(LS_KEY);

      meChip.style.display = "none";
      btnLogout.style.display = "none";
      sidebarSub.textContent = "Login to start";

      selectedUser = null;
      selectedTitle.textContent = "üë§ Select a user";
      hintText.textContent = "Login, then pick a user to load messages.";
      clearMessagesUI();

      setUiLocked(true);
      openAuthModal();
    }

    // ‚úÖ helper: fetch with auth header
    async function fetchAuth(url, options = {}) {
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        options.headers || {}
      );

      if (token) headers["Authorization"] = `Bearer ${token}`;

      const res = await fetch(url, { ...options, headers });

      // optional: auto-logout if token expired
      if (res.status === 401) {
        clearAuth();
        throw new Error("Session expired. Please login again.");
      }

      return res;
    }

    // ------------------ Users ------------------
    function renderUsers(users) {
      usersListEl.innerHTML = "";

      let shown = 0;

      for (const u of users) {
        if (me?._id && u._id === me._id) continue; // hide self

        shown++;

        const item = document.createElement("div");
        item.className = "userItem" + (selectedUser?._id === u._id ? " active" : "");
        item.dataset.id = u._id;

        item.innerHTML = `
          <div class="userTop">
            <div class="userName">${u.username}</div>
          </div>
          <div class="userId">${u._id}</div>
        `;

        item.addEventListener("click", () => selectUser(u));
        usersListEl.appendChild(item);
      }

      if (shown === 0) {
        usersListEl.innerHTML = `<div class="empty">No users found.</div>`;
      }
    }

    async function loadUsers() {
      setError("");
      // you can protect /users later. Keep public for now.
      const res = await fetch(`${BASE_URL}/users`);
      if (!res.ok) throw new Error("Failed to load users");
      allUsers = await res.json();
      applyUserFilter();
    }

    function applyUserFilter() {
      const q = (userSearchEl.value || "").toLowerCase().trim();
      const filtered = q
        ? allUsers.filter(u => (u.username || "").toLowerCase().includes(q))
        : allUsers;

      renderUsers(filtered);
    }

    async function selectUser(u) {
      selectedUser = u;
      setError("");

      selectedTitle.textContent = `üë§ ${u.username}`;
      hintText.textContent = `Conversation with ${u.username}`;

      applyUserFilter();
      setUiLocked(!me);

      await loadMessagesForSelectedUser();
    }

    // ------------------ Messages loading ------------------
    async function loadMessagesForSelectedUser() {
      if (!selectedUser?._id) return;

      clearMessagesUI();
      setError("");

      // ‚úÖ NEW backend: conversation endpoint
      const res = await fetchAuth(`${BASE_URL}/messages/with/${selectedUser._id}`, { method: "GET" });
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        setError(`GET /messages/with/:id failed. ${t ? ("(" + t + ")") : ""}`);
        showEmptyIfNeeded();
        return;
      }

      const messages = await res.json();

      // show oldest -> newest, but we prepend so reverse to keep newest on top
      for (let i = messages.length - 1; i >= 0; i--) {
        renderMessage(messages[i]);
      }
      showEmptyIfNeeded();
    }

    // ------------------ Message rendering ------------------
    function updateMessageInDOM(id, changes) {
      const el = document.getElementById("m_" + id);
      if (!el) return;

      if (changes.status) {
        const pill = el.querySelector(".pill");
        if (pill) {
          pill.className = "pill " + changes.status;
          pill.textContent = changes.status;
        }
      }
      if (typeof changes.content === "string") {
        const contentDiv = el.querySelector(".content");
        if (contentDiv) contentDiv.textContent = changes.content;
      }
    }

    function removeMessageFromDOM(id) {
      const el = document.getElementById("m_" + id);
      if (el) el.remove();
      showEmptyIfNeeded();
    }

    function getSenderName(msg) {
      // backend may send: fromUser / user
      return msg?.fromUser?.username
        || msg?.user?.username
        || "Unknown";
    }

    function isMine(msg) {
      const fromId = msg?.fromUserId || msg?.fromUser?._id;
      return !!(me?._id && fromId && (String(fromId) === String(me._id)));
    }

    function renderMessage(msg) {
      if (!msg?._id) return;
      if (document.getElementById("m_" + msg._id)) return;

      const div = document.createElement("div");
      div.className = "msg" + (isMine(msg) ? " mine" : "");
      div.id = "m_" + msg._id;

      const username = getSenderName(msg);
      const status = msg?.status ?? "";
      const date = msg?.createdAt ? formatDate(msg.createdAt) : "";

      div.innerHTML = `
        <div class="meta">
          <div>
            <b>${username}${isMine(msg) ? " (me)" : ""}</b>
            <span class="pill ${status}">${status}</span>
          </div>
          <div>${date}</div>
        </div>
        <div class="content"></div>
        <div class="msgActions">
          <button class="gray" data-action="seen">Mark seen</button>
          <button class="gray" data-action="sent">Mark sent</button>
          <button class="gray" data-action="delete">Delete</button>
        </div>
      `;

      div.querySelector(".content").textContent = msg?.content ?? "";

      div.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", async () => {
          const action = btn.getAttribute("data-action");
          if (!msg?._id) return;

          try {
            if (action === "delete") {
              const res = await fetchAuth(`${BASE_URL}/messages/${msg._id}`, { method: "DELETE" });
              if (!res.ok) throw new Error("Delete failed");
              removeMessageFromDOM(msg._id);
            } else {
              const res = await fetchAuth(`${BASE_URL}/messages/${msg._id}`, {
                method: "PATCH",
                body: JSON.stringify({ status: action })
              });
              if (!res.ok) throw new Error("Update failed");
              updateMessageInDOM(msg._id, { status: action });
            }
          } catch (e) {
            setError(e.message);
          }
        });
      });

      list.prepend(div);
      showEmptyIfNeeded();
    }

    // ------------------ Sending ------------------
    async function sendMessage() {
      setError("");
      const content = msgInput.value.trim();

      if (!me?._id) return setError("Login first.");
      if (!selectedUser?._id) return setError("Select a user first.");
      if (!content) return setError("Write a message first.");

      btnSend.disabled = true;

      try {
        // ‚úÖ NEW backend payload: { toUserId, content }
        const res = await fetchAuth(`${BASE_URL}/messages`, {
          method: "POST",
          body: JSON.stringify({ toUserId: selectedUser._id, content })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || "POST /messages failed");
        }

        msgInput.value = "";
        msgInput.focus();
      } catch (e) {
        setError(e.message);
      } finally {
        btnSend.disabled = false;
      }
    }

    // ------------------ Auth (JWT) ------------------
    async function doRegister() {
      setAuthError("");
      const username = (authUsername.value || "").trim();
      const password = (authPassword.value || "").trim();
      if (!username || !password) return setAuthError("Username + password are required.");

      btnRegister.disabled = true;
      btnLogin.disabled = true;

      try {
        const res = await fetch(`${BASE_URL}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || "Register failed");
        }

        const data = await res.json();
        if (!data?.access_token || !data?.user?._id) throw new Error("Invalid register response");

        saveAuth(data);
        closeAuthModal();
        await loadUsers();
      } catch (e) {
        setAuthError(e.message);
      } finally {
        btnRegister.disabled = false;
        btnLogin.disabled = false;
      }
    }

    async function doLogin() {
      setAuthError("");
      const username = (authUsername.value || "").trim();
      const password = (authPassword.value || "").trim();
      if (!username || !password) return setAuthError("Username + password are required.");

      btnRegister.disabled = true;
      btnLogin.disabled = true;

      try {
        const res = await fetch(`${BASE_URL}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || "Login failed");
        }

        const data = await res.json();
        if (!data?.access_token || !data?.user?._id) throw new Error("Invalid login response");

        saveAuth(data);
        closeAuthModal();
        await loadUsers();
      } catch (e) {
        setAuthError(e.message);
      } finally {
        btnRegister.disabled = false;
        btnLogin.disabled = false;
      }
    }

    btnLogin.addEventListener("click", doLogin);
    btnRegister.addEventListener("click", doRegister);

    authPassword.addEventListener("keydown", (e) => {
      if (e.key === "Enter") doLogin();
    });

    btnLogout.addEventListener("click", clearAuth);

    // ------------------ Socket ------------------
    const socket = io(BASE_URL);

    socket.on("connect", () => {
      connStatus.textContent = "‚úÖ Connected";
      connStatus.style.color = "#166534";
      console.log("connected:", socket.id);
    });

    socket.on("disconnect", () => {
      connStatus.textContent = "‚ùå Disconnected";
      connStatus.style.color = "#b91c1c";
    });

    // ‚úÖ new message payload now contains fromUserId/toUserId + fromUser/toUser
    socket.on("message:new", (msg) => {
      if (!me?._id || !selectedUser?._id) return;

      const fromId = String(msg?.fromUserId || msg?.fromUser?._id || "");
      const toId   = String(msg?.toUserId   || msg?.toUser?._id   || "");

      // show it only if it belongs to current open conversation
      const meId = String(me._id);
      const otherId = String(selectedUser._id);

      const belongs =
        (fromId === meId && toId === otherId) ||
        (fromId === otherId && toId === meId);

      if (belongs) renderMessage(msg);
    });

    socket.on("message:updated", (msg) => {
      if (msg?._id) updateMessageInDOM(msg._id, { status: msg.status, content: msg.content });
    });

    socket.on("message:deleted", ({ id }) => {
      if (id) removeMessageFromDOM(id);
    });

    // ------------------ Events ------------------
    btnReloadUsers.addEventListener("click", async () => {
      try { await loadUsers(); } catch (e) { setError(e.message); }
    });

    userSearchEl.addEventListener("input", applyUserFilter);

    btnSend.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    btnLoadOld.addEventListener("click", async () => {
      try { await loadMessagesForSelectedUser(); } catch (e) { setError(e.message); }
    });

    // ------------------ Boot ------------------
    (async () => {
      setUiLocked(true);

      const saved = localStorage.getItem(LS_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed?.token && parsed?.user?._id) {
            token = parsed.token;
            me = parsed.user;

            meName.textContent = me.username;
            meChip.style.display = "inline-flex";
            btnLogout.style.display = "inline-flex";
            sidebarSub.textContent = "Logged in. Select a user to see messages.";
            hintText.textContent = "Pick a user to load messages.";

            setUiLocked(false);
            closeAuthModal();
            await loadUsers();
            return;
          }
        } catch {}
      }

      openAuthModal();
    })();
  </script>
</body>
</html>
